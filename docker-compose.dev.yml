version: "3.8"

# ═══════════════════════════════════════════════════════════════
# DEVELOPMENT OVERRIDES FOR DOCKER COMPOSE
# ═══════════════════════════════════════════════════════════════
#
# This file extends docker-compose.yml with development-specific
# configurations. Use it with:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Or use the npm script:
#   npm run docker:up
#
# Changes from production:
# - More verbose logging
# - Exposed debug ports
# - Volume mounts for hot-reload (when services are built)
# - Relaxed security settings
# - Development environment variables
#
# ═══════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════
  # MONGODB - DEVELOPMENT SETTINGS
  # ═══════════════════════════════════════════════════════════════
  mongodb:
    environment:
      # Enable more verbose logging in development
      MONGO_LOG_LEVEL: debug
    # Expose additional port for MongoDB Compass or Studio 3T
    ports:
      - "${MONGODB_PORT:-27017}:27017"

  # ═══════════════════════════════════════════════════════════════
  # REDIS - DEVELOPMENT SETTINGS
  # ═══════════════════════════════════════════════════════════════
  redis:
    # Enable verbose logging
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme}
      --appendonly yes
      --loglevel debug

  # ═══════════════════════════════════════════════════════════════
  # MEILISEARCH - DEVELOPMENT SETTINGS
  # ═══════════════════════════════════════════════════════════════
  meilisearch:
    environment:
      MEILI_MASTER_KEY: ${MEILISEARCH_MASTER_KEY:-changeme_master_key_min_16_chars}
      MEILI_ENV: development
      MEILI_HTTP_ADDR: 0.0.0.0:7700
      MEILI_DB_PATH: /meili_data
      # Development-specific settings
      MEILI_LOG_LEVEL: DEBUG
      MEILI_MAX_INDEXING_MEMORY: 512MB
      MEILI_MAX_INDEXING_THREADS: 2
    # In development, you might want to access the web interface
    ports:
      - "${MEILISEARCH_PORT:-7700}:7700"

  # ═══════════════════════════════════════════════════════════════
  # QDRANT - DEVELOPMENT SETTINGS
  # ═══════════════════════════════════════════════════════════════
  qdrant:
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      # Development logging
      QDRANT__LOG_LEVEL: DEBUG
    # Expose web UI (if available in this version)
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"

  # ═══════════════════════════════════════════════════════════════
  # RABBITMQ - DEVELOPMENT SETTINGS
  # ═══════════════════════════════════════════════════════════════
  rabbitmq:
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-changeme}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-price_comparison}
      # Enable more plugins for development
      RABBITMQ_PLUGINS: rabbitmq_management,rabbitmq_prometheus
    # Make management UI easily accessible
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"

  # ═══════════════════════════════════════════════════════════════
  # APPLICATION SERVICES
  # ═══════════════════════════════════════════════════════════════

  # API Gateway (Node.js + Fastify)
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.dev
    volumes:
      # Mount source code for hot reload
      - ./apps/api/src:/app/apps/api/src
      - ./packages:/app/packages
      # Preserve node_modules from container
      - /app/node_modules
      - /app/apps/api/node_modules
      - /app/packages/types/node_modules
      - /app/packages/config/node_modules
      - /app/packages/utils/node_modules
    environment:
      NODE_ENV: development
      API_PORT: 4000
      # MongoDB - use Docker service name
      MONGODB_URI: mongodb://${MONGODB_USER:-admin}:${MONGODB_PASSWORD:-changeme}@mongodb:27017/${MONGODB_DATABASE:-price_comparison}?authSource=admin
      MONGODB_USERNAME: ${MONGODB_USER:-admin}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-changeme}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-price_comparison}
      # Redis - use Docker service name
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      # Meilisearch
      MEILISEARCH_HOST: http://meilisearch:7700
      MEILISEARCH_MASTER_KEY: ${MEILISEARCH_MASTER_KEY:-changeme_master_key_min_16_chars}
      # Qdrant
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      # RabbitMQ
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-changeme}
      # Enable polling for file watching in Docker
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "${API_PORT:-4000}:4000"
      - "9229:9229" # Node.js debug port
    depends_on:
      - mongodb
      - redis
      - meilisearch
      - qdrant
      - rabbitmq
    networks:
      - price-comparison-network

  # Web Frontend (React + Vite)
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    volumes:
      # Mount source code for hot reload
      - ./apps/web/src:/app/apps/web/src
      - ./apps/web/public:/app/apps/web/public
      # Mount config files
      - ./apps/web/vite.config.ts:/app/apps/web/vite.config.ts:ro
      - ./apps/web/tsconfig.json:/app/apps/web/tsconfig.json:ro
      - ./apps/web/tsconfig.app.json:/app/apps/web/tsconfig.app.json:ro
      - ./apps/web/tsconfig.node.json:/app/apps/web/tsconfig.node.json:ro
      - ./apps/web/index.html:/app/apps/web/index.html:ro
      # Preserve node_modules from container
      - /app/node_modules
      - /app/apps/web/node_modules
    environment:
      NODE_ENV: development
      VITE_API_URL: http://localhost:${API_PORT:-4000}
      # Enable polling for file watching in Docker
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - api
    networks:
      - price-comparison-network

  # Scraper Service (Python + FastAPI)
  # scraper:
  #   build:
  #     context: ./services/scraper
  #     dockerfile: Dockerfile
  #   volumes:
  #     - ./services/scraper/src:/app/src:ro
  #   environment:
  #     PYTHON_ENV: development
  #     LOG_LEVEL: DEBUG
  #   ports:
  #     - "${SCRAPER_PORT:-5000}:5000"
  #     - "5678:5678"  # Python debugpy port

  # Normalizer Service (Python)
  # normalizer:
  #   build:
  #     context: ./services/normalizer
  #     dockerfile: Dockerfile
  #   volumes:
  #     - ./services/normalizer/src:/app/src:ro
  #   environment:
  #     PYTHON_ENV: development
  #     LOG_LEVEL: DEBUG
  #   ports:
  #     - "${NORMALIZER_PORT:-5001}:5001"

  # Search Service (Python + FastAPI)
  # search:
  #   build:
  #     context: ./services/search
  #     dockerfile: Dockerfile
  #   volumes:
  #     - ./services/search/src:/app/src:ro
  #   environment:
  #     PYTHON_ENV: development
  #     LOG_LEVEL: DEBUG
  #   ports:
  #     - "${SEARCH_PORT:-5002}:5002"

  # Recommendation Engine (Python)
  # recommendation-engine:
  #   build:
  #     context: ./services/recommendation-engine
  #     dockerfile: Dockerfile
  #   volumes:
  #     - ./services/recommendation-engine/src:/app/src:ro
  #   environment:
  #     PYTHON_ENV: development
  #     LOG_LEVEL: DEBUG
  #   ports:
  #     - "${RECOMMENDATION_PORT:-5003}:5003"
